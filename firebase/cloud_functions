const functions = require('firebase-functions');
const admin = require('firebase-admin');
admin.initializeApp();

exports.checkPayment = functions.firestore
  .document('users/{userId}')
  .onUpdate(async (change, context) => {
    const userData = change.after.data();
    const lastPayment = userData.lastPayment.toDate();
    const today = new Date();
    const daysWithoutPayment = Math.floor((today - lastPayment) / (1000 * 60 * 60 * 24));

    if (daysWithoutPayment > 10) {
      await change.after.ref.update({ isActive: false });
      await admin.messaging().sendToDevice(userData.fcmToken, {
        notification: {
          title: "Contribuição Pendente",
          body: "Renove sua contribuição para continuar recebendo mensagens!",
        },
      });
    }
  });